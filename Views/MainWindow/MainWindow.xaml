<Window x:Class="AI.KB.Assistant.Views.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        mc:Ignorable="d"
        Title="AI.KB.Assistant" Height="820" Width="1250"
        MinHeight="600" MinWidth="960"
        WindowStartupLocation="CenterScreen"
        Background="{DynamicResource App.BackgroundBrush}"
        Foreground="{DynamicResource App.TextBrush}"
        AllowDrop="True"
        Drop="Window_Drop"
        DragOver="Window_DragOver">

    <!-- 快捷鍵：CTRL+O / CTRL+ENTER / CTRL+I / CTRL+T -->
    <Window.InputBindings>
        <KeyBinding Gesture="CTRL+O"     Command="{Binding OpenInboxCommand, RelativeSource={RelativeSource AncestorType=Window}}"/>
        <KeyBinding Gesture="CTRL+ENTER" Command="{Binding PrimaryActionCommand, RelativeSource={RelativeSource AncestorType=Window}}"/>
        <KeyBinding Gesture="CTRL+I"     Command="{Binding ToggleInfoPaneCommand, RelativeSource={RelativeSource AncestorType=Window}}"/>
        <KeyBinding Gesture="CTRL+T"     Command="{Binding ToggleTreePaneCommand, RelativeSource={RelativeSource AncestorType=Window}}"/>
    </Window.InputBindings>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <!-- 工具列 -->
            <RowDefinition Height="*"/>
            <!-- 主內容 -->
            <RowDefinition Height="Auto"/>
            <!-- 底部訊息 -->
        </Grid.RowDefinitions>

        <!-- ============ 工具列 ============ -->
        <Border Grid.Row="0" Background="{DynamicResource App.SecondaryBrush}" Padding="8,6"
                BorderBrush="{DynamicResource App.BorderBrush}" BorderThickness="0,0,0,1">
            <ScrollViewer HorizontalScrollBarVisibility="Disabled" VerticalScrollBarVisibility="Disabled">
                <WrapPanel ItemHeight="32" VerticalAlignment="Center">

                    <!-- 工作流程 -->
                    <Button Content="📂收件夾" Margin="0,0,6,0" Height="32" Click="BtnOpenInbox_Click" Style="{StaticResource TonedBtn}"/>
                    <Button Content="＋加入"  Margin="0,0,6,0" Height="32" Click="BtnAddFiles_Click"  Style="{StaticResource TonedBtn}"/>

                    <!-- 快捷動作（全用 TonedBtn 與其餘一致） -->
                    <Button Content="🔍檢視分類" Margin="0,0,6,0" Height="32" Click="BtnStartClassify_Click" Style="{StaticResource TonedBtn}"/>
                    <Button Content="✅確認搬檔" Margin="0,0,6,0" Height="32" Click="BtnCommit_Click"        Style="{StaticResource TonedBtn}"/>
                    <Button Content="⟳重新整理" Margin="0,0,10,0" Height="32" Click="BtnRefresh_Click"       Style="{StaticResource TonedBtn}"/>

                    <!-- 左右欄切換 -->
                    <Button Content="🗂️路徑索引" Margin="0,0,6,0"  Height="32" Click="BtnEdgeLeft_Click"  Style="{StaticResource TonedBtn}"/>
                    <Button Content="💾資訊"    Margin="0,0,14,0" Height="32" Click="BtnEdgeRight_Click" Style="{StaticResource TonedBtn}"/>

                    <!-- 專案鎖定 -->
                    <StackPanel Orientation="Horizontal" VerticalAlignment="Center" Margin="0,0,8,0">
                        <TextBlock Text="專案：" VerticalAlignment="Center" Margin="0,0,6,0"/>
                        <ComboBox x:Name="CbLockProject" Width="170" IsEditable="True" Margin="0,0,6,0"
                                  SelectionChanged="CbLockProject_SelectionChanged"/>
                        <Button Content="🔒/🔓鎖定專案" Width="126" Height="28" Click="BtnLockProject_Click"
                                Style="{StaticResource TonedBtn}" Margin="0,0,6,0"/>
                        <TextBox x:Name="TbProjectSearch" Width="140" Height="28" Margin="0,0,6,0" ToolTip="搜尋專案"/>
                        <Button Content="搜尋" Height="28" Click="BtnSearchProject_Click" Style="{StaticResource TonedBtn}"/>
                    </StackPanel>

                    <TextBlock x:Name="TxtLockedProject" VerticalAlignment="Center" Margin="4,0,10,0"
                               Foreground="{DynamicResource App.TextMutedBrush}"/>

                    <!-- 設定 -->
                    <Button Content="⚙設定" Margin="0,0,6,0" Height="32" Click="BtnOpenSettings_Click" Style="{StaticResource TonedBtn}"/>
                </WrapPanel>
            </ScrollViewer>
        </Border>

        <!-- ============ 主內容三欄 ============ -->
        <Grid Grid.Row="1">
            <Grid.ColumnDefinitions>
                <!-- 左欄：樹 -->
                <ColumnDefinition x:Name="LeftPaneColumn" Width="280"/>
                <!-- 中欄：清單 -->
                <ColumnDefinition Width="*"/>
                <!-- 右欄：資訊 -->
                <ColumnDefinition x:Name="RightPaneColumn" Width="360"/>
            </Grid.ColumnDefinitions>

            <!-- 左欄：路徑樹（僅 顯示「資料庫」與「收件夾」捷徑，再附加各磁碟） -->
            <Border Grid.Column="0" Margin="8" Padding="10"
                    Background="{DynamicResource App.PanelBrush}" BorderBrush="{DynamicResource App.BorderBrush}"
                    BorderThickness="1" CornerRadius="8">
                <DockPanel>
                    <StackPanel Orientation="Horizontal" DockPanel.Dock="Top" Margin="0,0,0,8">
                        <TextBlock Text="路徑：" VerticalAlignment="Center" Margin="0,0,6,0"/>
                        <TextBox x:Name="TvFilterBox" Width="180" Height="26" VerticalAlignment="Center"
                                 TextChanged="TvFilterBox_TextChanged" ToolTip="在目前層級快速篩選"/>
                    </StackPanel>

                    <TreeView x:Name="TvFolders" SelectedItemChanged="TvFolders_SelectedItemChanged">
                        <TreeView.ContextMenu>
                            <ContextMenu>
                                <MenuItem Header="在檔案總管開啟" Click="Tree_OpenInExplorer_Click"/>
                                <Separator/>
                                <MenuItem Header="將此資料夾檔案加入收件夾" Click="Tree_MoveFolderToInbox_Click"/>
                                <Separator/>
                                <MenuItem Header="鎖定為專案" Click="Tree_LockProject_Click"/>
                                <MenuItem Header="解除專案鎖定" Click="Tree_UnlockProject_Click"/>
                                <Separator/>
                                <MenuItem Header="重新命名資料夾" Click="Tree_Rename_Click"/>
                            </ContextMenu>
                        </TreeView.ContextMenu>
                    </TreeView>
                </DockPanel>
            </Border>

            <!-- 中欄：清單與導覽 -->
            <Grid Grid.Column="1" Margin="0,8">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <!-- Banner -->
                    <RowDefinition Height="Auto"/>
                    <!-- Breadcrumb -->
                    <RowDefinition Height="Auto"/>
                    <!-- Tabs -->
                    <RowDefinition Height="*"/>
                    <!-- List -->
                    <RowDefinition Height="Auto"/>
                    <!-- 批次列 -->
                </Grid.RowDefinitions>

                <!-- Banner（顯示提示 + 鎖定專案） -->
                <Border x:Name="Banner" Grid.Row="0" Margin="8,0,8,8" Padding="10"
                        Background="{DynamicResource App.BannerInfoBrush}" BorderBrush="{DynamicResource App.BorderBrush}"
                        BorderThickness="1" CornerRadius="8" Visibility="Collapsed">
                    <StackPanel>
                        <TextBlock x:Name="BannerText"/>
                        <TextBlock Margin="0,4,0,0" Foreground="{DynamicResource App.TextMutedBrush}">
                            <TextBlock.Style>
                                <Style TargetType="TextBlock">
                                    <Setter Property="Visibility" Value="Visible"/>
                                    <Setter Property="Text">
                                        <Setter.Value>
                                            <MultiBinding StringFormat="目前鎖定：{0}">
                                                <Binding ElementName="CbLockProject" Path="Text"/>
                                            </MultiBinding>
                                        </Setter.Value>
                                    </Setter>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding ElementName=CbLockProject, Path=Text}" Value="">
                                            <Setter Property="Visibility" Value="Collapsed"/>
                                        </DataTrigger>
                                        <DataTrigger Binding="{Binding ElementName=CbLockProject, Path=Text}" Value="{x:Null}">
                                            <Setter Property="Visibility" Value="Collapsed"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </TextBlock.Style>
                        </TextBlock>
                    </StackPanel>
                </Border>

                <!-- Breadcrumb -->
                <StackPanel x:Name="PathStrip" Grid.Row="1" Orientation="Horizontal" Margin="8,0,8,8"/>

                <!-- 分頁（狀態篩選） -->
                <TabControl x:Name="MainTabs" Grid.Row="2" Margin="8,0,8,8" SelectionChanged="MainTabs_SelectionChanged">
                    <TabItem Header="主頁面" Tag="home"/>
                    <TabItem Header="我的最愛" Tag="fav"/>
                    <TabItem Header="處理中" Tag="processing"/>
                    <TabItem Header="待處理" Tag="backlog"/>
                    <TabItem Header="黑名單" Tag="blacklist"/>
                    <TabItem Header="待確認" Tag="autosort-staging"/>
                </TabControl>

                <!-- 清單 -->
                <Border Grid.Row="3" Margin="8,0,8,8" Padding="6"
                        Background="{DynamicResource App.PanelBrush}" BorderBrush="{DynamicResource App.BorderBrush}"
                        BorderThickness="1" CornerRadius="8">
                    <ListView x:Name="FileList"
                              SelectionMode="Extended"
                              SelectionChanged="FileList_SelectionChanged"
                              PreviewMouseDoubleClick="FileList_PreviewMouseDoubleClick"
                              KeyDown="FileList_KeyDown"
                              ContextMenuOpening="FileList_ContextMenuOpening">
                        <ListView.View>
                            <GridView x:Name="MainGridView">
                                <GridViewColumn Header="檔名" Width="320" DisplayMemberBinding="{Binding Filename}"/>
                                <GridViewColumn Header="副檔名" Width="100" DisplayMemberBinding="{Binding Ext}"/>
                                <GridViewColumn Header="專案" Width="160" DisplayMemberBinding="{Binding Project}"/>
                                <GridViewColumn Header="類型/標籤" Width="200" DisplayMemberBinding="{Binding Tags}"/>
                                <GridViewColumn Header="路徑" Width="340" DisplayMemberBinding="{Binding Path}"/>
                                <GridViewColumn Header="預計路徑" Width="360" DisplayMemberBinding="{Binding PredictedPath}"/>
                            </GridView>
                        </ListView.View>

                        <!-- 右鍵選單（標籤子選單由程式動態注入） -->
                        <ListView.ContextMenu>
                            <ContextMenu>
                                <MenuItem Header="開啟" Click="CtxOpenFile_Click"/>
                                <MenuItem Header="複製完整路徑" Click="CtxCopyPath_Click"/>
                                <MenuItem Header="在資料夾開啟" Click="CtxOpenFolder_Click"/>
                                <Separator/>
                                <MenuItem Header="指定專案..." Click="CtxSetProject_Click"/>
                                <!-- 設定標籤容器：由 CS 在開啟時動態填入項目 -->
                                <MenuItem x:Name="TagsRoot" Header="設定標籤">
                                    <MenuItem x:Name="TagsSubmenu" Header="（載入中…）" IsEnabled="False"/>
                                </MenuItem>
                                <Separator/>
                                <MenuItem Header="重新命名..." Click="CtxRename_Click"/>
                                <MenuItem Header="移到收件夾" Click="CtxMoveToInbox_Click"/>
                                <Separator/>
                                <MenuItem Header="刪除檔案" Click="CtxDelete_Click"/>
                            </ContextMenu>
                        </ListView.ContextMenu>

                        <!-- 讓右鍵先選取該列 -->
                        <ListView.ItemContainerStyle>
                            <Style TargetType="ListViewItem">
                                <EventSetter Event="PreviewMouseRightButtonDown" Handler="ListViewItem_PreviewMouseRightButtonDown"/>
                            </Style>
                        </ListView.ItemContainerStyle>
                    </ListView>
                </Border>

                <!-- 批次列 / 計數 -->
                <DockPanel Grid.Row="4" Margin="8,0,8,8">
                    <StackPanel x:Name="BatchBar" Orientation="Horizontal" Visibility="Collapsed">
                        <TextBlock Text="已選取多筆，可使用右鍵進行批次操作。" VerticalAlignment="Center" Margin="0,0,12,0"/>
                    </StackPanel>
                    <TextBlock x:Name="TxtCounter" DockPanel.Dock="Right" VerticalAlignment="Center" />
                </DockPanel>
            </Grid>

            <!-- 右欄：資訊 -->
            <Border Grid.Column="2" Margin="8" Padding="10"
                    Background="{DynamicResource App.PanelBrush}" BorderBrush="{DynamicResource App.BorderBrush}"
                    BorderThickness="1" CornerRadius="8">
                <ScrollViewer VerticalScrollBarVisibility="Auto">
                    <StackPanel>

                        <!-- 檔案摘要 -->
                        <GroupBox Header="檔案摘要" Margin="0,0,0,10">
                            <StackPanel Margin="8">
                                <TextBlock Text="檔名：" FontWeight="Bold"/>
                                <TextBlock x:Name="RtName" Margin="0,0,0,6"/>
                                <TextBlock Text="類型/專案/標籤：" FontWeight="Bold"/>
                                <TextBlock x:Name="RtMeta" Margin="0,0,0,6"/>
                                <TextBlock Text="路徑：" FontWeight="Bold"/>
                                <TextBlock x:Name="RtPath" TextWrapping="Wrap" />
                            </StackPanel>
                        </GroupBox>

                        <!-- LLM 協助 -->
                        <GroupBox Header="LLM 協助" Margin="0,0,0,10">
                            <StackPanel Margin="8">
                                <StackPanel Orientation="Horizontal" Margin="0,0,0,6">
                                    <Button Content="產生建議專案" Margin="0,0,6,0" Click="BtnGenTags_Click" Style="{StaticResource TonedBtn}"/>
                                    <Button Content="摘要" Margin="0,0,6,0" Click="BtnSummarize_Click" Style="{StaticResource TonedBtn}"/>
                                    <Button Content="信心分析" Click="BtnAnalyzeConfidence_Click" Style="{StaticResource TonedBtn}"/>
                                </StackPanel>
                                <TextBox x:Name="RtLlmOut" Height="120" TextWrapping="Wrap" AcceptsReturn="True"/>
                            </StackPanel>
                        </GroupBox>

                        <!-- 自動整理設定（右欄快調） -->
                        <GroupBox Header="自動整理設定">
                            <StackPanel Margin="8">
                                <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                                    <TextBlock Text="信心閾值：" Margin="0,0,6,0" VerticalAlignment="Center"/>
                                    <Slider x:Name="RtThreshold" Minimum="0" Maximum="1" Width="160" Margin="0,0,6,0"/>
                                    <TextBlock x:Name="RtThresholdValue" Width="48" VerticalAlignment="Center"/>
                                </StackPanel>

                                <TextBlock Text="黑名單資料夾名（多筆以逗號分隔）：" Margin="0,10,0,6"/>
                                <TextBox x:Name="RtBlacklist" Height="28"/>

                                <StackPanel Orientation="Horizontal" Margin="0,10,0,0">
                                    <Button Content="套用" Margin="0,0,6,0" Click="BtnApplyAiTuning_Click" Style="{StaticResource TonedBtn}"/>
                                    <Button Content="重新載入" Click="BtnReloadSettings_Click" Style="{StaticResource TonedBtn}"/>
                                </StackPanel>
                            </StackPanel>
                        </GroupBox>

                    </StackPanel>
                </ScrollViewer>
            </Border>

            <!-- 中欄與右欄之間可拖拉的分隔線 -->
            <GridSplitter Grid.Column="1" Width="4" HorizontalAlignment="Right" Margin="0,8"
                          Background="{DynamicResource App.SecondaryBrush}" />
            <!-- 左欄與中欄之間可拖拉的分隔線 -->
            <GridSplitter Grid.Column="0" Width="4" HorizontalAlignment="Right" Margin="0,8"
                          Background="{DynamicResource App.SecondaryBrush}" />
        </Grid>

        <!-- ============ 底部訊息列（可收合） ============ -->
        <Expander x:Name="LogExpander" Grid.Row="2" IsExpanded="True"
                  Background="{DynamicResource App.PanelBrush}" BorderBrush="{DynamicResource App.BorderBrush}"
                  BorderThickness="1" Margin="8" >
            <Expander.Header>
                <StackPanel Orientation="Horizontal">
                    <TextBlock Text="⚠ 訊息（可收合）" FontWeight="Bold"/>
                </StackPanel>
            </Expander.Header>
            <ScrollViewer Height="110">
                <TextBox x:Name="LogBox" IsReadOnly="True" TextWrapping="Wrap" AcceptsReturn="True"
                         Background="Transparent" BorderThickness="0"/>
            </ScrollViewer>
        </Expander>
    </Grid>
</Window>
