<Window x:Class="AI.KB.Assistant.Views.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:local="clr-namespace:AI.KB.Assistant.Helpers"
        Title="AI 本地知識庫（第二階段）"
        Height="760" Width="1280"
        WindowStartupLocation="CenterScreen"
        AllowDrop="True"
        Drop="Window_Drop"
        DragEnter="Window_DragEnter">

    <Window.Resources>
        <local:UnixToDateConverter x:Key="UnixToDateConverter"/>
        <local:StringSplitConverter x:Key="StringSplitConverter"/>
    </Window.Resources>

    <DockPanel>
        <!-- 上方工具列 -->
        <StackPanel DockPanel.Dock="Top" Orientation="Horizontal" Background="#EEE" Margin="5">
            <TextBox x:Name="SearchBox" Width="260" Height="26" Margin="0,0,8,0"/>
            <Button Content="搜尋" Width="70" Margin="0,0,8,0" Click="BtnSearch_Click"/>
            <Button Content="清除" Width="70" Margin="0,0,8,0" Click="BtnClearSearch_Click"/>
            <Button Content="搬檔" Width="70" Margin="0,0,8,0" Click="BtnExecuteMove_Click"/>
            <Button Content="取消" Width="70" Margin="0,0,8,0" Click="BtnCancelQueue_Click"/>
            <Button Content="復原" Width="70" Margin="0,0,8,0" Click="BtnUndo_Click"/>
            <Button Content="重做" Width="70" Margin="0,0,8,0" Click="BtnRedo_Click"/>
            <Button Content="設定" Width="70" Margin="0,0,8,0" Click="BtnSettings_Click"/>
            <Button Content="說明" Width="70" Margin="0,0,8,0" Click="BtnHelp_Click"/>
            <TextBlock x:Name="StatSummary" VerticalAlignment="Center" Margin="12,0,0,0"/>
        </StackPanel>

        <!-- 主區域 -->
        <Grid>
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="250"/>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="350"/>
            </Grid.ColumnDefinitions>

            <!-- 左側路徑樹 -->
            <Border Grid.Column="0" BorderBrush="#CCC" BorderThickness="0,0,1,0" Padding="5">
                <TreeView x:Name="PathTree" SelectedItemChanged="PathTree_SelectedItemChanged">
                    <TreeView.ItemTemplate>
                        <HierarchicalDataTemplate ItemsSource="{Binding Children}">
                            <StackPanel Orientation="Horizontal">
                                <CheckBox Content="{Binding Name}"
                                          IsChecked="{Binding IsChecked, Mode=TwoWay}"
                                          Checked="PathNode_Checked"
                                          Unchecked="PathNode_Unchecked"/>
                            </StackPanel>
                        </HierarchicalDataTemplate>
                    </TreeView.ItemTemplate>
                </TreeView>
            </Border>

            <!-- 中間檔案清單 -->
            <Grid Grid.Column="1">
                <Grid.RowDefinitions>
                    <RowDefinition Height="*"/>
                    <RowDefinition Height="120"/>
                </Grid.RowDefinitions>

                <ListView x:Name="FileList" Grid.Row="0"
                          SelectionMode="Extended"
                          SelectionChanged="FileList_SelectionChanged">
                    <ListView.View>
                        <GridView>
                            <GridViewColumn Header="檔名" Width="220" DisplayMemberBinding="{Binding Filename}"/>
                            <GridViewColumn Header="分類" Width="100" DisplayMemberBinding="{Binding Category}"/>
                            <GridViewColumn Header="狀態" Width="100" DisplayMemberBinding="{Binding Status}"/>
                            <GridViewColumn Header="標籤" Width="150">
                                <GridViewColumn.CellTemplate>
                                    <DataTemplate>
                                        <ItemsControl ItemsSource="{Binding Tags, Converter={StaticResource StringSplitConverter}}">
                                            <ItemsControl.ItemTemplate>
                                                <DataTemplate>
                                                    <Border Background="#DDD" Margin="2,0" Padding="4,1" CornerRadius="3">
                                                        <TextBlock Text="{Binding}" FontSize="12"/>
                                                    </Border>
                                                </DataTemplate>
                                            </ItemsControl.ItemTemplate>
                                        </ItemsControl>
                                    </DataTemplate>
                                </GridViewColumn.CellTemplate>
                            </GridViewColumn>
                            <GridViewColumn Header="信心" Width="80" DisplayMemberBinding="{Binding Confidence}"/>
                            <GridViewColumn Header="日期" Width="100">
                                <GridViewColumn.CellTemplate>
                                    <DataTemplate>
                                        <TextBlock Text="{Binding CreatedTs, Converter={StaticResource UnixToDateConverter}}"/>
                                    </DataTemplate>
                                </GridViewColumn.CellTemplate>
                            </GridViewColumn>
                        </GridView>
                    </ListView.View>
                </ListView>

                <TextBlock x:Name="SelectionInfo"
                           Grid.Row="1"
                           Margin="5"
                           VerticalAlignment="Center"/>
            </Grid>

            <!-- 右側預覽區 -->
            <DockPanel Grid.Column="2" LastChildFill="True" Margin="5">
                <TextBlock x:Name="PreviewHeader" FontWeight="Bold" FontSize="14" DockPanel.Dock="Top" Margin="0,0,0,6"/>
                <ScrollViewer VerticalScrollBarVisibility="Auto">
                    <StackPanel>
                        <Image x:Name="PreviewImage" MaxHeight="200" Stretch="Uniform" Visibility="Collapsed"/>
                        <TextBox x:Name="PreviewText"
                                 IsReadOnly="True"
                                 TextWrapping="Wrap"
                                 AcceptsReturn="True"
                                 Visibility="Collapsed"
                                 VerticalScrollBarVisibility="Auto"/>
                    </StackPanel>
                </ScrollViewer>
            </DockPanel>
        </Grid>

        <!-- 下方 Log -->
        <DockPanel DockPanel.Dock="Bottom" Height="140">
            <TextBox x:Name="TxtLog"
                     IsReadOnly="True"
                     AcceptsReturn="True"
                     TextWrapping="Wrap"
                     VerticalScrollBarVisibility="Auto"/>
            <Button Content="清除" DockPanel.Dock="Right" Width="70" Click="BtnClearLog_Click"/>
        </DockPanel>
    </DockPanel>
</Window>
