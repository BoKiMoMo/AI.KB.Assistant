<Window x:Class="AI.KB.Assistant.Views.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:local="clr-namespace:AI.KB.Assistant.Helpers"
        xmlns:helpers="clr-namespace:AI.KB.Assistant.Helpers"
        Title="AI 本地知識庫"
        Height="720" Width="1280"
        WindowStartupLocation="CenterScreen"
        AllowDrop="True"
        Drop="Window_Drop"
        DragEnter="Window_DragEnter">

    <Window.Resources>
        <local:UnixToDateConverter x:Key="UnixToDateConverter"/>
        <local:StringSplitConverter x:Key="StringSplitConverter"/>

        <!-- Tag 樣式（小徽章） -->
        <Style x:Key="TagBadge" TargetType="Border">
            <Setter Property="Background" Value="#EEE"/>
            <Setter Property="CornerRadius" Value="4"/>
            <Setter Property="Padding" Value="4,1"/>
            <Setter Property="Margin" Value="2,0"/>
        </Style>

        <!-- ListView 行為：避免選擇改變焦點樣式過度突兀 -->
        <Style TargetType="ListViewItem">
            <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
        </Style>
    </Window.Resources>

    <DockPanel>

        <!-- 上方工具列（功能群 + 搜尋 + 主要命令） -->
        <Border DockPanel.Dock="Top" Background="#F7F7F7" BorderBrush="#DDD" BorderThickness="0,0,0,1" Padding="8">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>

                <!-- 第一排：功能群（設定、使用說明、待處理、我的最愛、執行中、自整理） -->
                <StackPanel Orientation="Horizontal" helpers:PanelSpacing.Spacing="8">
                    <Button Content="設定" Click="BtnSettings_Click"/>
                    <Button Content="使用說明" Click="BtnHelp_Click"/>
                    <Separator Width="8"/>
                    <Button Content="待處理" Click="BtnQueue_Click"/>
                    <Button Content="我的最愛" Click="BtnFavorite_Click"/>
                    <Button Content="執行中" Click="BtnRunning_Click"/>
                    <Button Content="自整理" Click="BtnAutoSort_Click"/>
                </StackPanel>

                <!-- 第二排：搜尋盒 + 主要動作 -->
                <StackPanel Grid.Row="1" Orientation="Horizontal"
                            Margin="0,8,0,0"
                            helpers:PanelSpacing.Spacing="8">
                    <TextBox x:Name="SearchBox" Width="300" Height="28" />
                    <Button Content="搜尋" Width="80" Click="BtnSearch_Click"/>

                    <Separator Width="8"/>

                    <Button Content="搬檔" Width="80" Click="BtnExecuteMove_Click"/>
                    <Button Content="復原" Width="80" Click="BtnUndo_Click"/>
                    <Button Content="重做" Width="80" Click="BtnRedo_Click"/>

                    <Separator Width="8"/>

                    <Button Content="新增標籤" Width="90" Click="AddTag_Click"/>
                    <Button Content="移除標籤" Width="90" Click="RemoveTag_Click"/>
                    <Button Content="改為待處理" Width="100" Click="MarkPending_Click"/>
                    <Button Content="改為執行中" Width="100" Click="MarkInProgress_Click"/>

                    <TextBlock x:Name="StatSummary"
                               VerticalAlignment="Center"
                               Margin="16,0,0,0"
                               Foreground="#666"/>
                </StackPanel>
            </Grid>
        </Border>

        <!-- 下方 Log -->
        <DockPanel DockPanel.Dock="Bottom" Height="140" LastChildFill="True">
            <Border BorderBrush="#DDD" BorderThickness="1,1,1,0">
                <TextBox x:Name="TxtLog"
                         IsReadOnly="True"
                         TextWrapping="Wrap"
                         AcceptsReturn="True"
                         VerticalScrollBarVisibility="Auto"/>
            </Border>
            <StackPanel DockPanel.Dock="Right"
                        Orientation="Vertical"
                        helpers:PanelSpacing.Spacing="8"
                        Margin="6,0,0,0">
                <Button Content="清除" Width="80" Click="BtnClearLog_Click"/>
                <Button Content="複製" Width="80" Click="BtnCopyLog_Click"/>
            </StackPanel>
        </DockPanel>

        <!-- 主區域 -->
        <Grid>
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="280"/>
                <!-- 左：路徑樹 -->
                <ColumnDefinition Width="*"/>
                <!-- 中：清單 -->
                <ColumnDefinition Width="380"/>
                <!-- 右：預覽 -->
            </Grid.ColumnDefinitions>

            <!-- 左側：路徑樹 + 範疇鎖定 -->
            <Border Grid.Column="0" BorderBrush="#DDD" BorderThickness="0,0,1,0">
                <DockPanel>
                    <StackPanel DockPanel.Dock="Top" Orientation="Horizontal"
                                Margin="8"
                                helpers:PanelSpacing.Spacing="8">
                        <TextBlock Text="範疇鎖定：" VerticalAlignment="Center"/>
                        <CheckBox x:Name="ChkScopeLock" Content="鎖定專案" VerticalAlignment="Center" Checked="ChkScopeLock_Checked" Unchecked="ChkScopeLock_Unchecked"/>
                        <Button Content="選資料夾…" Click="BtnPickFolder_Click"/>
                    </StackPanel>

                    <TreeView x:Name="PathTree"
                              SelectedItemChanged="PathTree_SelectedItemChanged"
                              Margin="8,0,8,8">
                        <TreeView.ItemTemplate>
                            <HierarchicalDataTemplate ItemsSource="{Binding Children}">
                                <StackPanel Orientation="Horizontal" helpers:PanelSpacing.Spacing="6">
                                    <CheckBox IsChecked="{Binding IsChecked, Mode=TwoWay}"/>
                                    <TextBlock Text="{Binding Name}"/>
                                </StackPanel>
                            </HierarchicalDataTemplate>
                        </TreeView.ItemTemplate>
                    </TreeView>
                </DockPanel>
            </Border>

            <!-- 中間：清單 + 選取資訊 -->
            <Grid Grid.Column="1">
                <Grid.RowDefinitions>
                    <RowDefinition Height="*"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>

                <ListView x:Name="FileList"
                          Grid.Row="0"
                          SelectionMode="Extended"
                          SelectionChanged="FileList_SelectionChanged"
                          Margin="8">
                    <ListView.View>
                        <GridView>
                            <GridViewColumn Header="檔名" Width="260" DisplayMemberBinding="{Binding Filename}"/>
                            <GridViewColumn Header="分類" Width="120" DisplayMemberBinding="{Binding Category}"/>
                            <GridViewColumn Header="狀態" Width="90" DisplayMemberBinding="{Binding Status}"/>

                            <GridViewColumn Header="標籤" Width="180">
                                <GridViewColumn.CellTemplate>
                                    <DataTemplate>
                                        <ItemsControl ItemsSource="{Binding Tags, Converter={StaticResource StringSplitConverter}}">
                                            <ItemsControl.ItemsPanel>
                                                <ItemsPanelTemplate>
                                                    <WrapPanel/>
                                                </ItemsPanelTemplate>
                                            </ItemsControl.ItemsPanel>
                                            <ItemsControl.ItemTemplate>
                                                <DataTemplate>
                                                    <Border Style="{StaticResource TagBadge}">
                                                        <TextBlock Text="{Binding}" FontSize="12"/>
                                                    </Border>
                                                </DataTemplate>
                                            </ItemsControl.ItemTemplate>
                                        </ItemsControl>
                                    </DataTemplate>
                                </GridViewColumn.CellTemplate>
                            </GridViewColumn>

                            <GridViewColumn Header="信心" Width="70" DisplayMemberBinding="{Binding Confidence}"/>

                            <GridViewColumn Header="日期" Width="110">
                                <GridViewColumn.CellTemplate>
                                    <DataTemplate>
                                        <TextBlock Text="{Binding CreatedTs, Converter={StaticResource UnixToDateConverter}}"/>
                                    </DataTemplate>
                                </GridViewColumn.CellTemplate>
                            </GridViewColumn>
                        </GridView>
                    </ListView.View>
                </ListView>

                <Border Grid.Row="1" BorderBrush="#DDD" BorderThickness="1,0,1,1" Padding="8" Margin="8,0,8,8">
                    <StackPanel Orientation="Horizontal" helpers:PanelSpacing.Spacing="12">
                        <TextBlock Text="已選取：" />
                        <TextBlock x:Name="SelectionInfo" FontWeight="Bold"/>
                    </StackPanel>
                </Border>
            </Grid>

            <!-- 右側：預覽 -->
            <DockPanel Grid.Column="2" Margin="8">
                <TextBlock x:Name="PreviewHeader"
                           DockPanel.Dock="Top"
                           FontWeight="Bold"
                           FontSize="14"
                           Margin="0,0,0,6"/>
                <ScrollViewer VerticalScrollBarVisibility="Auto">
                    <StackPanel helpers:PanelSpacing.Spacing="8">
                        <Image x:Name="PreviewImage" MaxHeight="220" Stretch="Uniform" Visibility="Collapsed"/>
                        <TextBox x:Name="PreviewText"
                                 IsReadOnly="True"
                                 TextWrapping="Wrap"
                                 AcceptsReturn="True"
                                 VerticalScrollBarVisibility="Auto"
                                 Visibility="Collapsed"/>
                    </StackPanel>
                </ScrollViewer>
            </DockPanel>
        </Grid>
    </DockPanel>
</Window>
