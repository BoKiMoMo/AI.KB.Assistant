<Window x:Class="AI.KB.Assistant.Views.SettingsWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        Title="設定 - AI.KB Assistant" Width="1000" Height="740"
        WindowStartupLocation="CenterOwner" ResizeMode="CanResize">
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="*" />
            <RowDefinition Height="Auto" />
        </Grid.RowDefinitions>

        <ScrollViewer Grid.Row="0" VerticalScrollBarVisibility="Auto">
            <StackPanel Margin="16" Orientation="Vertical">

                <!-- 路徑設定 -->
                <GroupBox Header="路徑設定">
                    <Grid Margin="10">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="180"/>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="110"/>
                        </Grid.ColumnDefinitions>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="10"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="10"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>

                        <TextBlock Grid.Row="0" Grid.Column="0" VerticalAlignment="Center" Text="分類根目錄"/>
                        <TextBox   x:Name="TbRootDir" Grid.Row="0" Grid.Column="1" Margin="8,0"/>
                        <Button    Grid.Row="0" Grid.Column="2" Content="瀏覽…" Click="BtnBrowseRoot_Click"/>
                        <TextBlock Grid.Row="1" Grid.Column="1" Grid.ColumnSpan="2" Foreground="{DynamicResource {x:Static SystemColors.GrayTextBrushKey}}"
                       Text="系統的主要資料根目錄；檔案會依照路徑規則搬入此資料夾。"/>

                        <TextBlock Grid.Row="3" Grid.Column="0" VerticalAlignment="Center" Text="收件夾 (HotFolder)"/>
                        <TextBox   x:Name="TbHotFolder" Grid.Row="3" Grid.Column="1" Margin="8,0"/>
                        <Button    Grid.Row="3" Grid.Column="2" Content="瀏覽…" Click="BtnBrowseHot_Click"/>
                        <TextBlock Grid.Row="4" Grid.Column="1" Grid.ColumnSpan="2" Foreground="{DynamicResource {x:Static SystemColors.GrayTextBrushKey}}"
                       Text="檔案先投入此資料夾；啟用監控時會自動匯入並依規則/AI 分類。"/>

                        <TextBlock Grid.Row="6" Grid.Column="0" VerticalAlignment="Center" Text="SQLite 資料庫"/>
                        <TextBox   x:Name="TbDbPath" Grid.Row="6" Grid.Column="1" Margin="8,0"/>
                        <Button    Grid.Row="6" Grid.Column="2" Content="選擇檔案…" Click="BtnBrowseDb_Click"/>
                        <TextBlock Grid.Row="7" Grid.Column="1" Grid.ColumnSpan="2" Foreground="{DynamicResource {x:Static SystemColors.GrayTextBrushKey}}"
                       Text="系統使用的本機輕量級資料庫（.db/.sqlite）；若留空會自動建立於預設路径。"/>
                    </Grid>
                </GroupBox>

                <!-- 啟動設定 -->
                <GroupBox Header="啟動設定" Margin="0,12,0,0">
                    <Grid Margin="10">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="180"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>

                        <TextBlock Grid.Row="0" Grid.Column="0" VerticalAlignment="Center" Text="啟動模式 (Launch Mode)"/>
                        <StackPanel Grid.Row="0" Grid.Column="1" Margin="8,0,0,0" VerticalAlignment="Center">
                            <RadioButton x:Name="RadioModeSimple" Content="簡易模式 (啟動後自動分類並關閉)" Tag="Simple" GroupName="LaunchMode" Margin="0,5,0,0"/>
                            <RadioButton x:Name="RadioModeDetailed" Content="詳細模式 (標準介面，手動管理)" Tag="Detailed" GroupName="LaunchMode" Margin="0,5,0,0"/>
                        </StackPanel>
                        <TextBlock Grid.Row="1" Grid.Column="1" Grid.ColumnSpan="2" Margin="8,4,0,0" Foreground="{DynamicResource {x:Static SystemColors.GrayTextBrushKey}}"
                       Text="選擇 App 啟動時要進入的介面。"/>

                        <!-- [V13.0 移除] 移除 V12.0 的檔案樹勾選框 -->
                    </Grid>
                </GroupBox>

                <!-- [V13.0 新增] 檔案樹自訂根目錄 -->
                <GroupBox Header="檔案樹自訂根目錄" Margin="0,12,0,0">
                    <Grid Margin="10">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="180"/>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="110"/>
                        </Grid.ColumnDefinitions>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>

                        <TextBlock Grid.Row="0" Grid.Column="0" VerticalAlignment="Top" Text="自訂根目錄 (一行一個路徑)"/>
                        <TextBox   x:Name="TbTreeViewRoots" Grid.Row="0" Grid.Column="1" Margin="8,0,0,0"
                                   Height="120" AcceptsReturn="True" VerticalScrollBarVisibility="Auto"
                                   TextWrapping="NoWrap"/>

                        <Button    x:Name="BtnAddRootPath" Grid.Row="0" Grid.Column="2" Content="瀏覽並加入…" 
                                   VerticalAlignment="Top" Click="BtnAddRootPath_Click"/>

                        <TextBlock Grid.Row="1" Grid.Column="1" Grid.ColumnSpan="2" Foreground="{DynamicResource {x:Static SystemColors.GrayTextBrushKey}}"
                                   Text="您在上方「Root 目錄」設定的路徑會自動包含在內。" Margin="8,4,0,0"/>
                        <TextBlock Grid.Row="2" Grid.Column="1" Grid.ColumnSpan="2" Foreground="{DynamicResource {x:Static SystemColors.GrayTextBrushKey}}"
                                   Text="範例：C:\Users\YourName\Projects" Margin="8,4,0,0"/>
                    </Grid>
                </GroupBox>


                <!-- 匯入與監控 -->
                <GroupBox Header="匯入與監控 (Import &amp; Monitoring)" Margin="0,12,0,0">
                    <Grid Margin="10">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="180"/>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="110"/>
                        </Grid.ColumnDefinitions>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="10"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="10"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="10"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>

                        <TextBlock Grid.Row="0" Grid.Column="0" VerticalAlignment="Center" Text="包含子資料夾"/>
                        <CheckBox  x:Name="CbIncludeSubdir" Grid.Row="0" Grid.Column="1" Content="啟用"/>
                        <TextBlock Grid.Row="1" Grid.Column="1" Grid.ColumnSpan="2" Foreground="{DynamicResource {x:Static SystemColors.GrayTextBrushKey}}"
                       Text="勾選後，從 Root/HotFolder 匯入時會一併掃描所有子資料夾。"/>

                        <TextBlock Grid.Row="3" Grid.Column="0" VerticalAlignment="Center" Text="啟用收件夾即時監控"/>
                        <CheckBox  x:Name="CbEnableHotFolder" Grid.Row="3" Grid.Column="1" Content="啟用"/>
                        <TextBlock Grid.Row="4" Grid.Column="1" Grid.ColumnSpan="2" Foreground="{DynamicResource {x:Static SystemColors.GrayTextBrushKey}}"
                       Text="勾選後，檔案放入收件夾即自動觸發匯入（FileSystemWatcher）。"/>

                        <TextBlock Grid.Row="6" Grid.Column="0" VerticalAlignment="Center" Text="加入方式 (MoveMode)"/>
                        <ComboBox  x:Name="CbMoveMode" Grid.Row="6" Grid.Column="1" Margin="8,0,0,0"
                       SelectedValuePath="Tag" IsEditable="False" SelectedValue="copy">
                            <ComboBoxItem Tag="copy"  Content="copy / 複製檔案 (Copy files)"/>
                            <ComboBoxItem Tag="move"  Content="move / 搬移檔案 (Move files)"/>
                            <ComboBoxItem Tag="link"  Content="link / 建立捷徑 (Create link)"/>
                        </ComboBox>
                        <TextBlock Grid.Row="7" Grid.Column="1" Grid.ColumnSpan="2" Foreground="{DynamicResource {x:Static SystemColors.GrayTextBrushKey}}"
                       Text="選擇匯入時的檔案處理：複製/搬移/捷徑。"/>

                        <TextBlock Grid.Row="9" Grid.Column="0" VerticalAlignment="Center" Text="覆寫策略 (OverwritePolicy)"/>
                        <ComboBox  x:Name="CbOverwrite" Grid.Row="9" Grid.Column="1" Margin="8,0,0,0"
                       SelectedValuePath="Tag" IsEditable="False" SelectedValue="KeepBoth">
                            <ComboBoxItem Tag="KeepBoth" Content="KeepBoth / 保留兩份"/>
                            <ComboBoxItem Tag="Rename"   Content="Rename / 自動重新命名"/>
                            <ComboBoxItem Tag="Replace"  Content="Replace / 直接覆蓋"/>
                        </ComboBox>
                        <TextBlock Grid.Row="10" Grid.Column="1" Grid.ColumnSpan="2" Foreground="{DynamicResource {x:Static SystemColors.GrayTextBrushKey}}"
                       Text="搬檔遇到同名檔案時的處理方式，建議先用 Rename 或 KeepBoth，避免覆蓋重要檔案。"/>
                    </Grid>
                </GroupBox>

                <!-- 黑名單 -->
                <GroupBox Header="黑名單" Margin="0,12,0,0">
                    <Grid Margin="10">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="180"/>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="110"/>
                        </Grid.ColumnDefinitions>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="10"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>

                        <TextBlock Grid.Row="0" Grid.Column="0" VerticalAlignment="Top" Text="副檔名黑名單（以 , 或 ; 分隔）"/>
                        <TextBox   x:Name="TbBlacklistExts" Grid.Row="0" Grid.Column="1" Margin="8,0,0,0"/>
                        <TextBlock Grid.Row="1" Grid.Column="1" Grid.ColumnSpan="2" Foreground="{DynamicResource {x:Static SystemColors.GrayTextBrushKey}}"
                       Text="不處理的副檔名，例如：tmp, log, bak。"/>

                        <TextBlock Grid.Row="3" Grid.Column="0" VerticalAlignment="Top" Text="資料夾名稱黑名單（以 , 或 ; 分隔）"/>
                        <TextBox   x:Name="TbBlacklistFolders" Grid.Row="3" Grid.Column="1" Margin="8,0,0,0"/>
                        <TextBlock Grid.Row="4" Grid.Column="1" Grid.ColumnSpan="2" Foreground="{DynamicResource {x:Static SystemColors.GrayTextBrushKey}}"
                       Text="不處理的資料夾名稱，例如：_auto、_cache。"/>
                    </Grid>
                </GroupBox>

                <!-- 路徑邏輯 -->
                <GroupBox Header="路徑邏輯" Margin="0,12,0,0">
                    <Grid Margin="10">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="180"/>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="110"/>
                        </Grid.ColumnDefinitions>
                        <Grid.RowDefinitions>
                            <!-- 勾選層級 -->
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="10"/>
                            <!-- 層級順序 -->
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="10"/>
                            <!-- UseType -->
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="10"/>
                            <!-- LowConf -->
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="10"/>
                            <!-- Threshold -->
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>

                        <!-- 勾選層級（含類別） -->
                        <TextBlock Grid.Row="0" Grid.Column="0" VerticalAlignment="Center" Text="路徑層級"/>
                        <StackPanel Grid.Row="0" Grid.Column="1" Orientation="Horizontal">
                            <CheckBox x:Name="CbUseYear"      Content="年份層"   Margin="0,0,16,0"/>
                            <CheckBox x:Name="CbUseMonth"     Content="月份層"   Margin="0,0,16,0"/>
                            <CheckBox x:Name="CbUseProject"   Content="專案層"   Margin="0,0,16,0"/>
                            <CheckBox x:Name="CbUseCategory"  Content="類別層"/>
                        </StackPanel>
                        <TextBlock Grid.Row="1" Grid.Column="1" Grid.ColumnSpan="2" Foreground="{DynamicResource {x:Static SystemColors.GrayTextBrushKey}}"
                       Text="勾選的層級才會生效；下方可調整實際資料夾排列順序。"/>

                        <!-- 層級順序（ListBox + 上下移） -->
                        <TextBlock Grid.Row="3" Grid.Column="0" VerticalAlignment="Top" Text="層級順序（上/下移）"/>
                        <Grid Grid.Row="3" Grid.Column="1" Margin="8,0,0,0">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="Auto" />
                            </Grid.ColumnDefinitions>
                            <ListBox x:Name="LbFolderOrder" Grid.Column="0" Height="140"/>
                            <StackPanel Grid.Column="1" Margin="8,0,0,0">
                                <Button x:Name="BtnOrderUp"   Content="▲ 上移" Margin="0,0,0,6" Click="BtnOrderUp_Click"/>
                                <Button x:Name="BtnOrderDown" Content="▼ 下移" Click="BtnOrderDown_Click"/>
                            </StackPanel>
                        </Grid>
                        <TextBlock Grid.Row="4" Grid.Column="1" Grid.ColumnSpan="2" Foreground="{DynamicResource {x:Static SystemColors.GrayTextBrushKey}}"
                       Text="可用代號：year / month / project / category。未勾選的層級即使在清單中也會被忽略。"/>

                        <!-- UseType -->
                        <TextBlock Grid.Row="6" Grid.Column="0" VerticalAlignment="Center" Text="使用類型 (UseType)"/>
                        <ComboBox  x:Name="CbUseType" Grid.Row="6" Grid.Column="1" Margin="8,0,0,0"
                       SelectedValuePath="Tag" IsEditable="False" SelectedValue="rule+llm">
                            <ComboBoxItem Tag="rule"     Content="rule / 只用規則"/>
                            <ComboBoxItem Tag="llm"      Content="llm / 只用 AI"/>
                            <ComboBoxItem Tag="rule+llm" Content="rule+llm / 規則優先＋AI 補強"/>
                        </ComboBox>
                        <TextBlock Grid.Row="7" Grid.Column="1" Grid.ColumnSpan="2" Foreground="{DynamicResource {x:Static SystemColors.GrayTextBrushKey}}"
                       Text="分類策略：優先規則（關鍵字/黑名單/路徑邏輯），不足時再詢問 AI 建議。"/>

                        <!-- 信心不足資料夾 -->
                        <TextBlock Grid.Row="9" Grid.Column="0" VerticalAlignment="Center" Text="信心不足資料夾名稱"/>
                        <TextBox   x:Name="TbLowConfidence" Grid.Row="9" Grid.Column="1" Margin="8,0,0,0"/>
                        <TextBlock Grid.Row="10" Grid.Column="1" Grid.ColumnSpan="2" Foreground="{DynamicResource {x:Static SystemColors.GrayTextBrushKey}}"
                       Text="AI 或規則無法自動決定時，暫存到此資料夾待人工分類（建議：_pending）。"/>

                        <!-- 門檻 -->
                        <TextBlock Grid.Row="12" Grid.Column="0" VerticalAlignment="Center" Text="分類信心門檻"/>
                        <StackPanel Grid.Row="12" Grid.Column="1" Orientation="Horizontal" Margin="8,0,0,0">
                            <Slider x:Name="SlThreshold" Minimum="0" Maximum="1" Width="240" TickFrequency="0.05" IsSnapToTickEnabled="True"/>
                            <TextBox x:Name="TbThreshold" Width="64" Margin="8,0,0,0" HorizontalContentAlignment="Center"/>
                            <TextBlock Margin="8,0,0,0" VerticalAlignment="Center" Text="0.00 ~ 1.00"/>
                        </StackPanel>
                        <TextBlock Grid.Row="13" Grid.Column="1" Grid.ColumnSpan="2" Foreground="{DynamicResource {x:Static SystemColors.GrayTextBrushKey}}"
                       Text="當信心分數低於此值時，改送往『信心不足資料夾』；建議 0.60～0.85。"/>
                    </Grid>
                </GroupBox>

                <!-- AI 參數 -->
                <GroupBox Header="AI 參數" Margin="0,12,0,72">
                    <Grid Margin="10">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="180"/>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="110"/>
                        </Grid.ColumnDefinitions>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="10"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>

                        <TextBlock Grid.Row="0" Grid.Column="0" VerticalAlignment="Center" Text="OpenAI API Key"/>
                        <PasswordBox x:Name="TbApiKey" Grid.Row="0" Grid.Column="1" Margin="8,0,0,0"/>
                        <TextBlock Grid.Row="1" Grid.Column="1" Grid.ColumnSpan="2" Foreground="{DynamicResource {x:Static SystemColors.GrayTextBrushKey}}"
                       Text="僅在需要 LLM 輔助分類/標籤/摘要時使用；不填寫則僅使用規則模式。"/>

                        <TextBlock Grid.Row="3" Grid.Column="0" VerticalAlignment="Center" Text="Model"/>
                        <TextBox   x:Name="TbModel" Grid.Row="3" Grid.Column="1" Margin="8,0,0,0"/>
                        <TextBlock Grid.Row="4" Grid.Column="1" Grid.ColumnSpan="2" Foreground="{DynamicResource {x:Static SystemColors.GrayTextBrushKey}}"
                       Text="模型名稱，如 gpt-4o-mini、gpt-4.1 等；留空採預設。"/>
                    </Grid>
                </GroupBox>

            </StackPanel>
        </ScrollViewer>

        <!-- 置底按鈕列 -->
        <Border Grid.Row="1" Background="{DynamicResource {x:Static SystemColors.ControlBrushKey}}" Padding="8,10">
            <DockPanel LastChildFill="False">
                <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                    <Button x:Name="BtnReload" Content="重新載入" Margin="0,0,8,0" Click="BtnReload_Click"/>
                    <Button x:Name="BtnCancel" Content="取消"     Margin="0,0,8,0" Click="BtnCancel_Click"/>
                    <Button x:Name="BtnSave"   Content="儲存"     IsDefault="True" Click="BtnSave_Click"/>
                </StackPanel>
            </DockPanel>
        </Border>
    </Grid>
</Window>