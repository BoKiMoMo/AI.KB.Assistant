<Window x:Class="AI.KB.Assistant.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:local="clr-namespace:AI.KB.Assistant"
        Title="AI 知識庫助手（第二階段）"
        Height="760" Width="1280"
        WindowStartupLocation="CenterScreen"
        AllowDrop="True"
        Drop="Window_Drop"
        DragEnter="Window_DragEnter">
    <Window.Resources>
        <local:UnixToDateConverter x:Key="UnixToDateConverter"/>
        <local:StringSplitConverter x:Key="TagSplit"/>
        <!-- Tag Badge -->
        <Style x:Key="TagBadge" TargetType="Border">
            <Setter Property="CornerRadius" Value="8"/>
            <Setter Property="Padding" Value="2,0"/>
            <Setter Property="Margin" Value="2"/>
            <Setter Property="Background" Value="#223a5a"/>
            <Setter Property="BorderBrush" Value="#2e7cf6"/>
            <Setter Property="BorderThickness" Value="1"/>
        </Style>
    </Window.Resources>

    <DockPanel Margin="12">
        <!-- 工具列 -->
        <StackPanel DockPanel.Dock="Top" Orientation="Horizontal" Margin="0,0,0,8">
            <!-- 搜尋 + 清除 -->
            <Grid Width="360" Height="28" Margin="0,0,8,0">
                <TextBox x:Name="SearchBox" VerticalContentAlignment="Center" KeyDown="SearchBox_KeyDown"/>
                <TextBlock IsHitTestVisible="False" Margin="6,0,0,0" VerticalAlignment="Center" Foreground="#88000000"
                           Text="搜尋：filename:*.pdf  tag:發票  status:pending  category:財務">
                    <TextBlock.Style>
                        <Style TargetType="TextBlock">
                            <Setter Property="Visibility" Value="Collapsed"/>
                            <Style.Triggers>
                                <MultiDataTrigger>
                                    <MultiDataTrigger.Conditions>
                                        <Condition Binding="{Binding Text, ElementName=SearchBox}" Value=""/>
                                        <Condition Binding="{Binding IsKeyboardFocusWithin, ElementName=SearchBox}" Value="False"/>
                                    </MultiDataTrigger.Conditions>
                                    <Setter Property="Visibility" Value="Visible"/>
                                </MultiDataTrigger>
                            </Style.Triggers>
                        </Style>
                    </TextBlock.Style>
                </TextBlock>
            </Grid>
            <Button Content="搜尋" Width="80" Margin="0,0,6,0" Click="BtnSearch_Click"/>
            <Button Content="清除" Width="64" Margin="0,0,8,0" Click="BtnClearSearch_Click"/>

            <Separator Width="12"/>

            <Button Content="最近" Width="80" Margin="0,0,6,0" Click="BtnRecent_Click"/>
            <Button Content="處理中" Width="80" Margin="0,0,6,0" Click="BtnProgress_Click"/>
            <Button Content="待處理" Width="80" Margin="0,0,6,0" Click="BtnPending_Click"/>
            <Button Content="我的最愛" Width="100" Margin="0,0,6,0" Click="BtnFavorite_Click"/>
            <Button Content="自整理" Width="80" Margin="0,0,6,0" Click="BtnAutoSorted_Click"/>

            <Separator Width="12"/>

            <Button Content="執行搬檔" Width="100" Margin="0,0,6,0" Click="BtnExecuteMove_Click"/>
            <Button Content="取消佇列" Width="100" Margin="0,0,6,0" Click="BtnCancelQueue_Click"/>
            <Button Content="Undo" Width="64" Margin="0,0,6,0" Click="BtnUndo_Click"/>
            <Button Content="Redo" Width="64" Margin="0,0,6,0" Click="BtnRedo_Click"/>

            <Separator Width="12"/>

            <Button Content="使用教學" Width="100" Margin="0,0,6,0" Click="BtnHelp_Click"/>
            <Button Content="設定" Width="80" Click="BtnSettings_Click"/>
        </StackPanel>

        <!-- 主區域 -->
        <Grid>
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="360"/>
            </Grid.ColumnDefinitions>
            <Grid.RowDefinitions>
                <RowDefinition Height="*"/>
                <RowDefinition Height="28"/>
            </Grid.RowDefinitions>

            <!-- 清單 -->
            <ListView x:Name="ListView" Grid.Column="0" Grid.Row="0" Margin="0,0,8,8"
                      SelectionMode="Extended" SelectionChanged="ListView_SelectionChanged">
                <ListView.View>
                    <GridView AllowsColumnReorder="True">
                        <GridViewColumn Header="檔案" DisplayMemberBinding="{Binding Filename}" Width="320"/>
                        <GridViewColumn Header="分類" DisplayMemberBinding="{Binding Category}" Width="120"/>
                        <GridViewColumn Header="型態" DisplayMemberBinding="{Binding FileType}" Width="70"/>
                        <GridViewColumn Header="標籤" Width="220">
                            <GridViewColumn.CellTemplate>
                                <DataTemplate>
                                    <ItemsControl ItemsSource="{Binding Tags, Converter={StaticResource TagSplit}}">
                                        <ItemsControl.ItemsPanel>
                                            <ItemsPanelTemplate>
                                                <WrapPanel/>
                                            </ItemsPanelTemplate>
                                        </ItemsControl.ItemsPanel>
                                        <ItemsControl.ItemTemplate>
                                            <DataTemplate>
                                                <Border Style="{StaticResource TagBadge}">
                                                    <TextBlock Text="{Binding}" Margin="4,0" />
                                                </Border>
                                            </DataTemplate>
                                        </ItemsControl.ItemTemplate>
                                    </ItemsControl>
                                </DataTemplate>
                            </GridViewColumn.CellTemplate>
                        </GridViewColumn>
                        <GridViewColumn Header="信心" DisplayMemberBinding="{Binding Confidence}" Width="70"/>
                        <GridViewColumn Header="狀態" DisplayMemberBinding="{Binding Status}" Width="100"/>
                        <GridViewColumn Header="建立日" Width="110">
                            <GridViewColumn.CellTemplate>
                                <DataTemplate>
                                    <TextBlock Text="{Binding CreatedTs, Converter={StaticResource UnixToDateConverter}}"/>
                                </DataTemplate>
                            </GridViewColumn.CellTemplate>
                        </GridViewColumn>
                    </GridView>
                </ListView.View>

                <!-- 右鍵 -->
                <ListView.ContextMenu>
                    <ContextMenu>
                        <MenuItem Header="加入我的最愛" Click="MarkFavorite_Click"/>
                        <MenuItem Header="設為處理中" Click="MarkInProgress_Click"/>
                        <MenuItem Header="設為待處理" Click="MarkPending_Click"/>
                        <Separator/>
                        <MenuItem Header="新增標籤…" Click="AddTag_Click"/>
                        <MenuItem Header="移除標籤…" Click="RemoveTag_Click"/>
                        <Separator/>
                        <MenuItem Header="重跑分類" Click="Reclassify_Click"/>
                    </ContextMenu>
                </ListView.ContextMenu>
            </ListView>

            <!-- 右側：預覽 + 統計 -->
            <DockPanel Grid.Column="1" Grid.Row="0">
                <GroupBox Header="預覽" Margin="0,0,0,8">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                        </Grid.RowDefinitions>
                        <TextBlock x:Name="PreviewHeader" Margin="8" Text="（選取檔案以預覽）"/>
                        <ScrollViewer Grid.Row="1" Margin="8" VerticalScrollBarVisibility="Auto">
                            <StackPanel>
                                <Image x:Name="PreviewImage" MaxWidth="320" Visibility="Collapsed" Margin="0,0,0,8"/>
                                <TextBox x:Name="PreviewText" IsReadOnly="True" Visibility="Collapsed"
                                         TextWrapping="Wrap" VerticalScrollBarVisibility="Auto" Height="240"/>
                            </StackPanel>
                        </ScrollViewer>
                    </Grid>
                </GroupBox>

                <GroupBox Header="統計">
                    <StackPanel Margin="8">
                        <TextBlock x:Name="StatSummary" Text="本週新增：0；我的最愛：0；自整理：0"/>
                    </StackPanel>
                </GroupBox>
            </DockPanel>

            <!-- 底部：進度條 + 選取摘要 -->
            <DockPanel Grid.Row="1" Grid.ColumnSpan="2">
                <ProgressBar x:Name="Progress" Height="18" Minimum="0" Maximum="100" Margin="0,0,8,0" Width="300"/>
                <TextBlock x:Name="SelectionInfo" VerticalAlignment="Center" />
            </DockPanel>
        </Grid>

        <!-- Log -->
        <TextBox x:Name="TxtLog" DockPanel.Dock="Bottom" Height="140" IsReadOnly="True" TextWrapping="Wrap"
                 VerticalScrollBarVisibility="Auto" Margin="0,8,0,0"/>
    </DockPanel>
</Window>
